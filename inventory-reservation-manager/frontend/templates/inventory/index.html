{% extends "base.html" %}
{% load static %}

{% block title %}Inventory{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}

{% block content %}
<header>
    <nav class="navbar navbar-expand-lg tertiary-color accent-color px-2">
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                <li class="nav-item dropdown pl-2">
                    <input type="text" id="tableFilter" class="form-control py-2" style="min-width: 25vw;"
                        placeholder="Search...">
                </li>
                <li class="nav-item dropdown pl-2">
                    <button class="btn btn-outline-secondary py-2" id="clean_filter">
                        <i class="fa fa-broom"></i>
                    </button>
                </li>
            </ul>
            <a href="{% url 'item_add' %}" class="ml-auto">
                <button class="btn btn-outline-warning my-2 my-sm-0 py-2">Add <i class="fa fa-plus"></i></button>
            </a>
        </div>
    </nav>
</header>
<main class="py-4">
    <div class="container-fluid">
        <table class="overflow-auto w-100" id="inventory">
            <thead>
                <tr>
                    <th class="col-sm-1">Jméno</th>
                    <th class="col-sm-1">Inventární číslo</th>
                    <th class="col-sm-2">Fotka</th>
                    <th class="col-sm-2">Popis</th>
                    <th class="col-sm-1">Kalendář</th>
                    <th class="col-sm-1">Akce</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr class="altering">
                    <td class="col-sm-2" data-id="item_name" data-value="{{ item.name }}">{{ item.name }}</td>
                    <td class="col-sm-2" data-id="item_inventory_number" data-value="{{ item.inventory_number }}">{{ item.inventory_number }}</td>
                    <td class="col-sm-2"><img src="{{item.image.url}}" alt="{{item.image.name}}"
                            style="min-width: 10em; min-height: 10em; aspect-ratio: initial; max-width: 15em; max-height: 15em;"></td>
                    <td class="description col-sm-1">{{ item.description }}</td>
                    <td class="calendar col-sm-2">
                        <div class="calendar-container mx-0" data-item-id="{{ item.pk }}">
                            <div>
                                <button onclick="prevMonth(this)">⬅️</button>
                                <span class="month-year"></span>
                                <button onclick="nextMonth(this)">➡️</button>
                            </div>
                            <table class="calendar">
                                <thead>
                                    <tr>
                                        <th>Po</th><th>Út</th><th>St</th>
                                        <th>Čt</th><th>Pá</th><th>So</th><th>Ne</th>
                                    </tr>
                                </thead>
                                <tbody class="calendar-body"></tbody>
                            </table>
                        </div>
                    </td>
                    <td>
                        <form class="form-inline my-2 my-lg-0" id="reserve-form" method="get" action="{% url 'reservations_add' %}">
                            {% csrf_token %}
                            <input type="hidden" name="pk" value="{{ item.pk }}">
                            <button class="btn btn-outline-success my-2 my-sm-0 w-75" type="submit">Reserve <i class="fa fa-calendar"></i></button>
                        </form>
                        <form class="form-inline my-2 my-lg-0 py-2" id="reserve-form" method="get" action="{% url 'item_modify' %}">
                            {% csrf_token %}
                            <input type="hidden" name="pk" value="{{ item.pk }}">
                            <button class="btn btn-outline-warning my-2 my-sm-0 w-75" type="submit">Edit <i class="fa fa-edit"></i></button>
                        </form>
                        <form class="form-inline my-2 my-lg-0" id="reserve-form" method="get" action="{% url 'item_delete' %}">
                            {% csrf_token %}
                            <input type="hidden" name="pk" value="{{ item.pk }}">
                            <button class="btn btn-outline-danger my-2 my-sm-0 w-75" type="submit">Delete <i class="fa fa-trash"></i></button>
                        </form>
                    </td>
                </tr>

                {% endfor %}
            </tbody>
        </table>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    function update_filter(f) {
        let filter = f ? f.value.toLowerCase() : "";
        let rows = document.querySelectorAll("#inventory > tbody > tr");

        rows.forEach(row => {
            let titleElement = row.querySelector("[data-id='item_name']");
            let titleText = titleElement ? titleElement.getAttribute("data-value").toLowerCase() : "";
            let inventoryNumberElement = row.querySelector("[data-id='item_inventory_number']");
            let inventoryNumberText = inventoryNumberElement ? inventoryNumberElement.getAttribute("data-value").toLowerCase() : "";

            row.style.display = (titleText.includes(filter) || inventoryNumberText.includes(filter)) ? "" : "none";
        });
    }

    document.getElementById("tableFilter").addEventListener("keyup", function () {
        update_filter(this);
    });

    document.querySelector("#clean_filter").addEventListener("click", function(event) {
        let filterInput = document.getElementById("tableFilter");
        filterInput.value = "";
        update_filter(filterInput);
    })




    const userColors = {}; // Store assigned colors
    const colors = [
        "#FF5733", "#33FF57", "#3357FF", "#FF33A8", "#FFB833", "#8A33FF", "#33FFF5",
        "#FF3333", "#33FF8A", "#5733FF", "#FF8A33", "#A833FF", "#33FFA8", "#FF33F5",
        "#B8FF33", "#FF338A", "#338AFF", "#8AFF33", "#F5FF33", "#33A8FF", "#FF33C2",
        "#33FF33", "#FF8333", "#3385FF", "#85FF33", "#FF3385", "#3383FF", "#83FF33",
        "#FF8335", "#33FF83", "#3385FF"
    ];

    function getUserColor(name) {
        if (!userColors[name]) {
            userColors[name] = colors[Object.keys(userColors).length % colors.length];
        }
        return userColors[name];
    }

    document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".calendar-container").forEach(container => {
            let itemId = container.getAttribute("data-item-id");
            initCalendar(container, itemId);
        });
    });

    function initCalendar(container, itemId) {
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        let reservedDates = new Set();

        fetchReservations(itemId, function (data) {
            reservedDates = new Set(data.reserved);
            renderCalendar(container, currentYear, currentMonth, reservedDates, data.clients);
        });

        container.dataset.year = currentYear;
        container.dataset.month = currentMonth;
    }

    function fetchReservations(itemId, callback) {
        fetch(`{% url 'api_item_reservations' %}?pk=${itemId}`)
            .then(response => response.json())
            .then(data => callback(data))
            .catch(error => console.error("Error fetching reservations:", error));
    }

    function renderCalendar(container, year, month, reservedDates, clients) {
        let calendarBody = container.querySelector(".calendar-body");
        let monthYear = container.querySelector(".month-year");
        calendarBody.innerHTML = "";

        let firstDay = new Date(year, month, 1).getDay();
        firstDay = (firstDay === 0) ? 6 : firstDay - 1;  // Shift Sunday (0) to Monday (1)

        let lastDate = new Date(year, month + 1, 0).getDate();

        let date = 1;
        for (let i = 0; i < 6; i++) {
            let row = document.createElement("tr");
            if (date > lastDate) {
                break;
            }
            for (let j = 0; j < 7; j++) {
                let cell = document.createElement("td");
                if (i === 0 && j < firstDay) {
                    cell.innerHTML = "";
                } else if (date > lastDate) {
                    cell.innerHTML = "";
                } else {
                    let fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                    cell.innerHTML = date;
                    if (reservedDates.has(fullDate)) {
                        cell.classList.add("reserved");
                        cell.setAttribute('title', clients[fullDate])
                        let color = getUserColor(clients[fullDate]);
                        cell.style.backgroundColor = color;
                        cell.style.color = "white";
                    }
                    date++;
                }
                row.appendChild(cell);
            }
            calendarBody.appendChild(row);
        }
        monthYear.innerText = new Date(year, month).toLocaleString("default", { month: "long", year: "numeric" });
    }

    function prevMonth(button) {
        let container = button.closest(".calendar-container");
        let year = parseInt(container.dataset.year);
        let month = parseInt(container.dataset.month);
        if (--month < 0) {
            month = 11;
            year--;
        }
        container.dataset.year = year;
        container.dataset.month = month;
        let itemId = container.getAttribute("data-item-id");
        fetchReservations(itemId, function (data) {
            renderCalendar(container, year, month, new Set(data.reserved), data.clients);
        });
    }

    function nextMonth(button) {
        let container = button.closest(".calendar-container");
        let year = parseInt(container.dataset.year);
        let month = parseInt(container.dataset.month);
        if (++month > 11) {
            month = 0;
            year++;
        }
        container.dataset.year = year;
        container.dataset.month = month;
        let itemId = container.getAttribute("data-item-id");
        fetchReservations(itemId, function (data) {
            dates = data.reserved;
            renderCalendar(container, year, month, new Set(dates), data.clients);
        });
    }
</script>
{% endblock %}